
<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>National Park Attendance</title>
  <meta name="description" content="National Park Attendance">
  <meta name="author" content="Frey Hargarten - StarTribune">
  
  <link href="../_common_resources/charts/c3-master/c3.css" rel="stylesheet" type="text/css">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" /> 
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.css' type='text/css' />
  
  <style>
      body, #filter, #filter input:focus { font-family:"Benton Sans",Helvetica,Arial,sans-serif; }
      #chart .c3-line { stroke-width:6px !important; }

      #map { width:100%; height:200px; }
      .map-overlay-container { position: absolute; width:400px; top: 0; left: 0; padding: 10px; z-index: 1; }
      .map-overlay { font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif; background-color: #fff; border-radius: 3px; padding: 10px; box-shadow:0 1px 2px rgba(0,0,0,0.20); }
      .map-overlay h2, .map-overlay p { margin: 0 0 10px; }
      .mapboxgl-ctrl-attrib { display:none; }

      #wrapper { text-align:center; }

      #viewSwitch, #current { padding:10px; }
      .stat { font-weight:900; }

      #filter { padding:12px; }

      #chart { height:250px; }

      .source { font-size:0.8em; }

      #blurb { text-align:center; padding:15px; }
      #visitors { font-weight:900; color:#66AF50; }
      #parkname { font-weight:900; }

      #filter input { border-radius:0 !important; width:100% !important; }
      #filter { padding:0px !important; }

      p { text-align:center; margin-right:auto; margin-left:auto; padding:15px; }

      #geocoder-container { width:100%; margin-top:10px; }
      #geocoder-container > div { min-width:100%; margin-left:0; }

      #parksList { height:164px; overflow:auto; }
      .zoom { float:none !important; text-align:center; padding:15px; }

      .switch { padding:10px; display:inline-block; text-align:center; width:100%; background-color:#fff; font-weight:900; font-family:"Benton Sans",Helvetica,Arial,sans-serif; border:1px solid black; color:#000 !important; margin:0 !important; }
      .switch:hover, .selected, .step:hover { background-color:#4C4C39 !important; color:#fff !important; cursor:pointer; margin:0 !important; }

      @media (max-width:500px) {
      }
  </style> 
</head>

<body>
<div id="filter"><input type="search" id="filter_box" placeholder="Search by park name"></input></div>
<div id="parksList"></div>

<div id="blurb">In <span id="year"></span>, <span id="visitors"></span> people visited <span id="parkname"></span>.</div>

<div id="chart"></div>

<div id="map"></div>
<div id='geocoder-container'></div>
<div class="zoom">Reset View</div>

<p><small class="byline">Data Visualization by <a href="http://www.startribune.com/jeff-hargarten/274254381/" target="new_">Jeff Hargarten</a></small></p>
</body>

<script src="//code.jquery.com/jquery-latest.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="../_common_resources/charts/c3-master/c3.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.js'></script>

<script>
d3.json('./shapefiles/national_parks.json', function(error, parks) {
d3.csv("./data/visitors.csv", function(d) {
  return {
    state: d.STATE,
    name: d.NICKNAME,
    type: d.TYPE,
    fullname: d.FULLPARKNAME,
    code: d.UnitCode,
    year: d.YEAR,
    visitors: d.VISITORS
  };
}, function(error, rows0) {

d3.csv("./data/parks.csv", function(d) {
  return {
    state: d.STATE,
    name: d.NICKNAME,
    type: d.TYPE,
    fullname: d.FULLPARKNAME,
    code: d.UnitCode,
    latitude: d.Latitude,
    longitude: d.Longitude
  };
}, function(error, rows1) {

var dataVisits = rows0;
var dataParks = rows1;

//PARKS LIST
d3.select("#parksList").selectAll(".switch")
  .data(dataParks).enter().append("div")
  .attr("class",function(d) { return "switch"; })
  .attr("latitude",function(d) { return d.latitude; })
  .attr("longitude",function(d) { return d.longitude; })
  .html(function(d){ 
    return d.name;
  });

     $('#filter_box').keyup(function(i){
        $('.switch').hide();
        var txt = $('#filter_box').val();
        $('.switch').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
               $(this).show();
           }
        });
    });

    $(".switch").click(function()  { 
       $(".switch").removeClass("selected");
       $(this).addClass("selected");
       map.flyTo({ center: [$(this).attr("longitude"),$(this).attr("latitude")], zoom: 9 });
       switchChart($(this).text());
    });


//MAPPAGE
mapboxgl.accessToken = 'pk.eyJ1Ijoic2hhZG93ZmxhcmUiLCJhIjoiS3pwY1JTMCJ9.pTSXx_LFgR3XBpCNNxWPKA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/shadowflare/cimdyoofx00iv9qkpdj7o0izi',
    center: [-95.689444, 39.055833],
    zoom: 2,
    minZoom: 2
});

var geocoder = new mapboxgl.Geocoder({
    container: 'geocoder-container' // Optional. Specify a unique container for the control to be added to.
});

map.scrollZoom.disable();
map.addControl(geocoder);
map.addControl(new mapboxgl.Navigation());

map.on('load', function() {
$(".mapboxgl-ctrl-geocoder input").attr("placeholder","Search by address");

$(".zoom").click(function() {
map.flyTo({ center: [-95.689444, 39.055833], zoom: 2 });
$(".switch").removeClass("selected");
$('.switch').show();
$('.switch').first().addClass("selected");
switchChart("Abraham Lincoln Birthplace");
$("#filter input").text("");
$('#parksList').animate({scrollTop : 0},800);
return false;
});

geocoder.on('result', function(ev) {
  map.flyTo({ center: ev.result.geometry.coordinates, zoom: 7 });
    });


var sourceObj = new mapboxgl.GeoJSONSource({
   data: parks
});

map.addSource('parks', sourceObj);

map.addLayer({
        'id': 'shape-layer',
        'interactive': true,
        'type': 'fill',
        'source': 'parks',
        'paint': {
            'fill-antialias' : true,
            'fill-opacity': 0.5,
            'fill-color': "#66AF50",
            'fill-outline-color': '#66AF50'
        }
});

});

var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
});

map.on('mousemove', function(e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['shape-layer'] });
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

    if (!features.length) {
        popup.remove();
        return;
    }

    var feature = features[0];

    // Populate the popup and set its coordinates
    // based on the feature found.
    popup.setLngLat(e.lngLat)
        .setHTML(feature.properties.UNIT_NAME)
        .addTo(map);
});


function switchChart(name){

  var axis = [];
var dataStream = [];
axis[0] = 'x';
var indexYear = 1;

for (var j=1930; j<2016; j++){
  axis[indexYear] = j;
  dataStream[indexYear] = 0;
  indexYear++;
}

  $("#parkname").html(name);

  var found = false;
  dataStream[0] = "Visitors";
  var index = 0;

  for (var i=0; i < dataVisits.length; i++){
    if (name == dataVisits[i].name){

      found = true;
      index = i;
      for (var k=1; k < dataStream.length; k++){
        if (dataVisits[index].name != name){ break; }
        if (axis[k] == dataVisits[index].year) { 
          dataStream[k] = dataVisits[index].visitors;
          $("#visitors").html(d3.format(",")(dataVisits[index].visitors)); 
          $("#year").html(dataVisits[index].year);
          index++; 
        }
      }

    }
  }

if (found == true){

// console.log(dataStream);

var  padding = {
        top: 20,
        right: 60,
        bottom: 20,
        left: 60,
    };

var share = "#B0BEC5";

// console.log(axis);

var chart = c3.generate({
        bindto: '#chart',
        padding: padding,
    data: {
        x: 'x',
        columns: [
            axis,
            dataStream
        ],
        type: 'line'
    },
    color:  { pattern: ["#66AF50"] },
    axis: {
      y: {
            min: 0,
            padding: {bottom: 0},
            tick: {
             count: 4,
             format: d3.format(',.0f')
            }
        },
        x: {
            tick: {
                values: ['1930', '1950', '1990', '2015'],
                count: 4,
                multiline: false
            }
          }
        }
    //   tooltip: {
    //   contents: function (d, defaultTitleFormat, defaultValueFormat, color) {
    //       var $$ = this, config = $$.config,
    //           titleFormat = config.tooltip_format_title || defaultTitleFormat,
    //           nameFormat = config.tooltip_format_name || function (name) { return name; },
    //           valueFormat = config.tooltip_format_value || defaultValueFormat,
    //           text, i, title, value, name, bgcolor;
    //       for (i = 0; i < d.length; i++) {
    //           if (! (d[i] && (d[i].value || d[i].value === 0))) { continue; }

    //           if (! text) {
    //               title = titleFormat ? titleFormat(d[i].x) : d[i].x;
    //               text = "<table class='" + $$.CLASS.tooltip + "'>" + (title || title === 0 ? "<tr><th colspan='2'>" + title + "</th></tr>" : "");
    //           }

    //           var birthNum = 0;



    //           name = nameFormat(d[i].name);
    //           value = valueFormat(d[i].value, d[i].ratio, d[i].id, d[i].index);
    //           bgcolor = $$.levelColor ? $$.levelColor(d[i].value) : color(d[i].id);

    //           console.log(title);

    //           for (var k=0; k < rows.length; k++){
    //             if (rows[k].name == name && rows[k].year == Number(title)){
    //               birthNum = rows[k].births;
    //               break;
    //             }
    //           }

    //           text += "<tr class='" + $$.CLASS.tooltipName + "-" + d[i].id + "'>";
    //           text += "<td class='name'><span style='background-color:" + bgcolor + "'></span>Rate</td>";
    //           text += "<td class='value'>" + value + "</td>";
    //           text += "</tr><tr>";
    //           text += "<td class='name'><span style='background-color:" + bgcolor + "'></span>Total Births</td>";
    //           text += "<td class='value'>" + birthNum + "</td>";
    //           text += "</tr>";
              
    //       }
    //       return text + "</table>";
    //   }
    // }

  });
}
}
  
switchChart("Abraham Lincoln Birthplace");
$('.switch').first().addClass("selected");

});
});
});
</script>
</html>