
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Mapbox JS Template</title>
  <meta name="description" content="Mapbox JS Template">
  <meta name="author" content="Frey Hargarten - StarTribune">
    
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.css' rel='stylesheet' />
  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />

  <style>
     #map { position:absolute; height:400px; width:100%; min-height:400px; }
  </style>
</head>
<body>

<div class="chartHeader chartTitle">Minnesota House Legislative Districts</div>
<div id='map'></div>
<div class="breaker"></div>
<div class="chartFooter">
  <div class="sources">Source: Minnesota Secretary of State</div>
  <div class="branding"><a href="http://startribune.com/datadrop">startribune.com/datadrop</a></div>
</div>
<a href="https://docs.google.com/spreadsheets/d/1-2zKGGKgPe9Xer1MrRBI74Zy5TUi15HuZShdT-eJFFs/pub?output=xlsx" target="new_"><button class="downloadButton">&nbsp;Download data</button></a>

</body>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.js'></script>

<script>
d3.json("https://script.googleusercontent.com/macros/echo?user_content_key=Pfumyvlz_fB0BFqskOhG8MDLYE-sNA1gsqzqkjUSvZs6XYdRZEjr9x8urVK0khRBVaSG49jMh37UaVLo2jZ_HggzvY-EOwVPOJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMWojr9NvTBuBLhyHCd5hHaxCoMjMSmZWLp6XAShvjQj50JtCfh4yP7n1RnEoDeOH7XqmOXgX8RYIyMAhIAtjnF9UDzNXGLr6To3J9D8RNlRL0zgWNJzVDkWV4a9wKICNpTa8dfWNHYIymLIb4r3T2k2KsIDjhQ9px35iDyrfKhrq59nomqYSNlw&lib=MVcLnEUipyThKZcpmQKyqT_CoSfd4egCX", function(error, dataLoad) {

$.getJSON('../_common_resources/shapefiles/mnleg.json', function(dataMLeg) {

var dataDistricts = dataLoad.mn_house;
    
var mapBounds = new L.LatLngBounds(
              new L.LatLng(39.1982, -128.1445),
              new L.LatLng(50.5414, -68.2031));

L.mapbox.accessToken = 'pk.eyJ1Ijoic2hhZG93ZmxhcmUiLCJhIjoiODRHdjBSWSJ9.lF4ymp-69zdGvZ5X4Tokzg';
  var map = L.mapbox.map('map', 'mapbox.light', { maxZoom: 10, minZoom: 5, bounds: mapBounds})
    .setView([46.358056, -94.200833], 6);

  var popup = new L.Popup({ autoPan: false });
  var closeTooltip;

  // map.dragging.disable();
  map.touchZoom.disable();
  map.doubleClickZoom.disable();
  map.scrollWheelZoom.disable();

    var mnlegLayer = L.geoJson(dataMLeg,  {
      style: getStyleLEG,
      onEachFeature: onEachFeatureLEG
  }).addTo(map);

 function getStyleLEG(feature) {
      return {
          weight: 2,
          opacity: 0.3,
          color: 'black',
          fillOpacity: 1,
          fillColor: getColorLEG(feature.properties.DISTRICT)
      };
  }

  function getColorLEG(d) {
    for (var i=0; i < dataDistricts.length; i++){
      if (d == dataDistricts[i].county_id && dataDistricts[i].party_id == "R"){ var rValue = dataDistricts[i].vote_pct; }
      if (d == dataDistricts[i].county_id && dataDistricts[i].party_id == "DFL"){ var dValue = dataDistricts[i].vote_pct; }
    }

    if (dValue > rValue) { return "#223C69"; }
    else if (dValue < rValue) { return "#A50F16"; }
    else { return "#ddd"; }
  }

 function onEachFeatureLEG(feature, layer) {
      layer.on({
          mousemove: mousemoveLEG,
          mouseout: mouseoutLEG,
          click: zoomToFeatureLEG
      });
  }

  function mousemoveLEG(e) {
      var layer = e.target;

      popup.setLatLng(e.latlng);
      popup.setContent('<div class="marker-title">District ' + layer.feature.properties.DISTRICT + '</div>');

      if (!popup._map) popup.openOn(map);
      window.clearTimeout(closeTooltip);

      // highlight feature
      layer.setStyle({
          weight: 4,
          color: '#333'
      });

      if (!L.Browser.ie && !L.Browser.opera) {
          layer.bringToFront();
      }
  }

  function mouseoutLEG(e) {
    var layer = e.target;

    layer.setStyle({
          weight: 2,
          color: 'black'
      });

      closeTooltip = window.setTimeout(function() {
          map.closePopup();
      }, 100);
  }

  function zoomToFeatureLEG(e) {
    var layer = e.target;
    $("#infobox").html(layer.feature.properties.name);
    map.fitBounds(e.target.getBounds());
  }

});
});
</script>

</body>
</html>