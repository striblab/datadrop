
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Heatmaps</title>
  <meta name="description" content="Heatmaps">
  <meta name="author" content="Jeff Hargarten - StarTribune, Mapbox.js, Turf.js">

  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
  <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
  <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.3.0/mapbox.directions.css' type='text/css' />

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .mapbox-logo, .leaflet-control-attribution{ display:none !important; }

  body { margin: 0; padding: 0; }
  #map { bottom: 40px; position: absolute; top: 0; width: 100%; }
  #year { font-size: 250%; font-weight: 900; }
  #vizopts a { background: #000; box-sizing: border-box; color: #fff; display: inline-block; height: 40px; max-width: 10000px !important; position: absolute; text-align: center; top: 0px; width: 100%; }
  #progress { padding-top: 42px; transition: width 0.2s linear; width: 50%; }
  #hailtitle { font-size: 250%; font-weight: 900; }
  .leaflet-right .leaflet-control.mapbox-control-info { margin-bottom: 28px; }
</style>
</head>

<body>

<div id='map'></div>
    <div class='pin-top fill-navy pad1'>
        <div id='hailtitle' class='col2 dark pad1y'>US Hail</div>
        <div id='vizopts' class='radio-pill pill col10'>
            <input type='radio' name='opt' id='square' checked='checked'>
            <label for='square' class='col2 button icon check'>square</label>
            <input type='radio' name='opt' id='hex'>
            <label for='hex' class='col2 button icon check'>hex</label>
            <input type='radio' name='opt' id='triangle'>
            <label for='triangle' class='col2 button icon check'>triangle</label>
            <input type='radio' name='opt' id='point'>
            <label for='point' class='col2 button icon check'>point</label>
            <input type='radio' name='opt' id='heat'>
            <label for='heat' class='col2 button icon check'>heat</label>
        </div>
    </div>
    <div id='progress' class='pin-bottom fill-blue-light col12'>test</div>
    <div class='pin-bottom'>
        <div class='pad1 dark fill-navy col12'>
            <span class='pad1 col2' id='year'></span>
            <div class='radio-pill pill clearfix'>
                <input type='radio' name='speed' id='slow' >
                <label for='slow' class='col3 button icon check'>slow</label>
                <input type='radio' name='speed' id='medium' checked='checked'>
                <label for='medium' class='col3 button icon check'>medium</label>
                <input type='radio' name='speed' id='fast'>
                <label for='fast' class='col3 button icon check'>fast</label>
        </div>
    </div>
    </div>
</body>

<script src='//code.jquery.com/jquery-1.11.2.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.4.0/turf.min.js'></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script src='data/hexgrid.js'></script>
<script src='data/trigrid.js'></script>
<script src='data/squaregrid.js'></script>
<script src='data/pointgrid.js'></script>
<script src='data/chroniton.js'></script>

<script>
L.mapbox.accessToken = 'pk.eyJ1Ijoic2lsZW5jZWQiLCJhIjoiUm1IZjgyWSJ9.dAfyl93WqB8IOvxlPq-yyA';

var bbox =  [-126,25,-66,50];

var map = L.mapbox.map('map', 'mapbox.dark', 
    {zoomControl: false ,attributionControl: false, infoControl: true})
    .setView([37.5,-96], 4);
map.scrollWheelZoom.disable();

var layerGroup = L.layerGroup().addTo(map);

var activeGrid = squaregrid;
var activeGridName = 'square';
var speeds = {
    'slow': 1000,
    'medium': 200,
    'fast': 50
};
var speed = speeds.medium;

var year = 1955;
var i = 0;
setInterval(function(){
    if(i % speed === 0){
        setViz(activeGrid, year.toString());
        year++;
        if(year > 2013) year = 1955;
    }
    i+=5;
}, 1);

function setViz (grid, year) {
    // update year
    document.getElementById('progress').style.width = ((year-1955)/(2013-1955))*100+'%';
    document.getElementById('year').innerHTML = year;
    // filter empty data
    var filtered = turf.featurecollection([]);
    filtered.features = grid.features.filter(function(cell){
        return cell.properties[year];
    });
    // clear old data
    layerGroup.clearLayers();

    if(activeGridName === 'point') {
        // scaled point grid
        L.geoJson(activeGrid, {
            pointToLayer: function(feature, latlng) {
                var radius = 0;
                var prop = year.toString()+'_class';
                radius = feature.properties[prop];

                return L.circleMarker(latlng, {
                        radius: radius,
                        fillColor: '#0ff',
                        fillOpacity: (feature.properties[prop])/10,
                        stroke: false
                    });
            }
        }).addTo(layerGroup);
    } else if(activeGridName === 'heat') {
        // heatmap on points
        var contour = '#0ff';
        var heatData = filtered.features.map(function(pt) {
          return [pt.geometry.coordinates[1], pt.geometry.coordinates[0], pt.properties[year+'_class']/10];
        });
        L.heatLayer(heatData, { 
            maxZoom: 4,
            radius: 30,
            blur: 25,
            max:1,
            gradient: {0:contour,0.1:'#4dffff',
                0.2:'#00b3b3',0.21:contour,0.3:'#00b3b3',
                0.4:'#00cccc',0.41:contour,0.43:'#00cccc',
                0.6:'#00cccc',0.61:contour,0.63:'#00cccc',
                0.8:'#00e5e5',0.81:contour,0.83:'#00e5e5',
                0.988:'#4dffff',0.989:contour,0.90:'#4dffff',
                0.97:'#4dffff',0.98:contour,0.99:'#4dffff',
                1:'#fff'}
            }).addTo(layerGroup);
    } else {
        // poly grid layers
        var prop = year.toString()+'_class';
        filtered.features.forEach(function(cell) {
            cell.properties.fill = '#0ff';
            cell.properties['stroke-width'] = 0.2;
            cell.properties.stroke = '#0ff';
            cell.properties['stroke-opacity'] = (cell.properties[prop])/4;
            cell.properties['fill-opacity'] = (cell.properties[prop])/8.5;
        });

        L.geoJson(filtered, {
            style: L.mapbox.simplestyle.style,
        }).addTo(layerGroup);
    }
}

document.getElementById('square').onclick = function() { 
    activeGrid = squaregrid;
    activeGridName = 'square';
};
document.getElementById('triangle').onclick = function() { 
    activeGrid = trigrid;
    activeGridName = 'triangle';
};
document.getElementById('hex').onclick = function() { 
    activeGrid = hexgrid;
    activeGridName = 'hex';
};
document.getElementById('point').onclick = function() { 
    activeGrid = pointgrid;
    activeGridName = 'point';
};
document.getElementById('heat').onclick = function() { 
    activeGrid = pointgrid;
    activeGridName = 'heat';
};

// set speed
document.getElementById('slow').onclick = function() {
    speed = speeds.slow;
    document.getElementById('progress').style.transition = 'width 1s linear';
};
document.getElementById('medium').onclick = function() {
    speed = speeds.medium;
    document.getElementById('progress').style.transition = 'width 0.2s linear';
};
document.getElementById('fast').onclick = function() {
    speed = speeds.fast;
    document.getElementById('progress').style.transition = 'width 0.05s linear';
};

</script>

</html>