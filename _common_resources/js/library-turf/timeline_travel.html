
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Timeline Travel</title>
  <meta name="description" content="Timeline Travel">
  <meta name="author" content="Jeff Hargarten - StarTribune, Mapbox.js, Turf.js">

  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
  <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
  <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.3.0/mapbox.directions.css' type='text/css' />

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .mapbox-logo, .leaflet-control-attribution{ display:none !important; }

  body { margin: 0; }
  .leaflet-container { background: black; cursor: default; }
  #map { bottom: 41px; left: 300px; position: absolute; right: 0px; top: 0; }
  .small-input { vertical-align: middle; width: 80px; }
  .leaflet-popup-close-button { display: none; }
  .leaflet-popup-content { padding: 2px 1px 2px 2px; padding-top: 2px; }
  .leaflet-tile-pane { moz-transition: all 0.5s linear; webkit-transition: all 0.5s linear; }
  .leaflet-popup-content-wrapper, .map-legends, .map-tooltip { box-shadow: 0 1px 2px rgba(0,0,0,.5); }
  .raceroute { stroke-dasharray: 4, 6; }
  .mushermarker { fill: #f6fBf7; moz-transition: all 0.02s linear; stroke: #3887be; stroke-opacity: 1; stroke-width: 3; webkit-transition: all 0.02s linear; }
  .clock { background: white; border: 1px solid #ccc; border-radius: 50%; height: 100px; margin: 20px; width: 100px; }
  .daycount { padding-top: 65%; text-align: center; }
  .hand { border-radius: 2px; left: 50px; margin-left: -2px; moz-transform-origin: bottom center; moz-transition: all 0.5s linear; position: absolute; top: 50px; webkit-transform-origin: bottom center; webkit-transition: all 0.5s linear; width: 4px; }
  .big { background: #3887be; height: 30px; margin-top: -30px; }
  .little { background: black; height: 40px; margin-top: -40px; opacity: 0.1; }
  .knob { background: #3887be; border-radius: 4px; height: 8px; margin: -4px; width: 8px; }
  .sidebar { bottom: 41px; left: 0; position: absolute; top: 0; width: 300px; }
  #leaderboard { bottom: 0px; margin-top: 10px; overflow: scroll; position: absolute; top: 30px; width: 100%; }
  .leaflet-popup { margin-top: -20px; }
  .leaflet-marker-icon,
  .leaflet-marker-shadow { transition: all 0.2s linear; }
  .mushermarker { cursor: default; }
  .musherentry { background: #fafafa; cursor: default; height: 80px; moz-transition: -moz-transform 0.4s; position: absolute; webkit-transition: -webkit-transform 0.4s; width: 100%; }
  .musherentry:hover { background: white; }
  .relativewrapper { position: relative; }
  .entrymug { border-radius: 50%; height: 60px; margin-bottom: 40px; margin-right: 10px; overflow: hidden; width: 60px; }
  .musherentry p { line-height: 1.4em; }
  h3 { margin-top: 3px; }
  .milecount { color: #3887be; margin-top: 1px; }
  .flag { margin: 15px 10px; width: 20px; }
  input.timeslider { border: none; border-radius: 6px; }
  input[type=range]::-moz-slider-thumb { background: #B6DBE7; box-shadow: #3887be -1200px 0 0 1200px; cursor: -webkit-grab; }
  input[type=range]::-webkit-slider-thumb { background: #B6DBE7; border: 2px solid #3887be; box-shadow: #3887be -1200px 0 0 1200px; cursor: -webkit-grab; }
  input[type=range]::-webkit-slider-thumb:active { cursor: -webkit-grabbing; }
  .timescale { left: 190px; position: absolute; right: 10px; }
  .timescale div { display: inline; float: left; height: 5px; outline: 1px solid #ccc; overflow: hidden; text-align: center; width: 0; }
  .timescale .fourteenth { margin-left: 7.14%; }
  .popupmug { width: 30px; }
  .popupname { display: block; white-space: nowrap; }
</style>
</head>

<body>

<div id='map'></div>
<div class='pad1 fill-white pin-bottom keyline-top clearfix'>
  <span class='fl quiet'>RACE PROGRESS (DAYS)</span>
  <div class='timescale'>
    <fieldset class>
        <input class='timeslider col12' type='range' value='0' min='0' max='1209600' step='1' id='timeslider'>
    </fieldset>
      <div class='center hidden'>1</div>
      <div class='fourteenth'>2</div>
      <div class='fourteenth'>3</div>
      <div class='fourteenth'>4</div>
      <div class='fourteenth'>5</div>
      <div class='fourteenth'>6</div>
      <div class='fourteenth'>7</div>
      <div class='fourteenth'>8</div>
      <div class='fourteenth'>9</div>
      <div class='fourteenth'>10</div>
      <div class='fourteenth'>11</div>
      <div class='fourteenth'>12</div>
      <div class='fourteenth'>13</div>
      <div class='fourteenth'>14</div>
      <div class='fourteenth hidden'>15</div>
  </div>
</div>
<div class='clock pin-topright margin1'>
  <div class='little hand'></div>
  <div class='big hand'></div>
  <div class='knob hand'></div>
  <div class='daycount small strong uppercase quiet'>DAY 1</div>
</div>
<div class='sidebar fl fill-white'>
  <div class='space-bottom4 fill-blue dark center pad1 strong'>LEADERBOARD</div>
  <div id='leaderboard'></div>
</div>
</body>

<script src='//code.jquery.com/jquery-1.11.2.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.4.0/turf.min.js'></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script src='data/route.js'></script>
<script src='data/mushers.js'></script>
<script src='data/waypoints.js'></script>
<script src='data/legs.js'></script>

<script>
L.mapbox.accessToken = 'pk.eyJ1Ijoic2lsZW5jZWQiLCJhIjoiUm1IZjgyWSJ9.dAfyl93WqB8IOvxlPq-yyA';

var map = L.mapbox.map('map', 'andreasviglakis.76e0cee7', { zoomControl: false })
    .setView([62.034410,-151.74865722], 7);
map.scrollWheelZoom.disable();

new L.Control.Zoom({ position: 'bottomright' }).addTo(map);

route.properties = {
    "distance": 891.7517055325512,
    "stroke": "#dF0922",
    "stroke-width": 2,
    "stroke-opacity": 1
  };

//draw route
var racePath= L.geoJson(route, {
    style: L.mapbox.simplestyle.style,
    className:'raceroute'
}).addTo(map);

var cameraPath = {
  "type": "Feature",
  "geometry": {
    "type": "LineString",
    "coordinates": [
      [
        -151.74865722,
        62.034410
      ],
      [
        -157.000122,
        64.0361489
      ],
      [
        -162.03186035,
        64.34704306
      ]
    ]
  }
};


//map.fitBounds(route.getBounds());
drawWaypoints();

// time slider
var seconds = 0;
var simulatedTimeIncrement = 147;
var realTimeIncrement = 20;
var mushLayer = new L.layerGroup().addTo(map);

var mushPts = turf.featurecollection([]);

mushers.forEach(function(musher) {
    var feature = currentPt(musher, route, legs, seconds);
    feature.properties = musher;
    mushPts.features.push(feature);
});

mushLayer = new L.geoJson(mushPts,{
    pointToLayer: function(feature, latlng) {
        return new L.CircleMarker(latlng, {className: 'mushermarker '+feature.properties.name.replace(/\s/g, ''), radius: 5, fillOpacity: 0.85});
    },
    onEachFeature: function (feature, layer) {
        layer.bindPopup('<div style="width:60px;height:60px;overflow:hidden;border-radius:3px"><img class="" src="'+feature.properties.img+'"></div>',{autoPan:false, offset:[0,-4]});
    }
}).addTo(map)
    .on('mouseover', function(e) {e.layer.openPopup()})
    .on('mouseout', function(e) {e.layer.closePopup()});

setInterval(function(){
    var newPos= L.GeoJSON.coordsToLatLng(turf.along(cameraPath,seconds/2000,'miles').geometry.coordinates);
    map.panTo(newPos,{duration:2, easeLinearity:1});
},2000);

setInterval(function () {
    var mushPts = turf.featurecollection([]);
    mushLayer.eachLayer(function (layer) {
        layer.setLatLng(L.GeoJSON.coordsToLatLng(
            currentPt(layer.feature.properties, route, legs, seconds).geometry.coordinates));
    });
    if (seconds<1173600) seconds += simulatedTimeIncrement;
}, realTimeIncrement);

//set ambient daylight, time slider, and clock(500ms=1hr intervals)
var updateInterval=500;     // refresh rate
var anticipateAnimation = (updateInterval/realTimeIncrement)*simulatedTimeIncrement;    //must be one step ahead, because we're animating TO this point
var startSeconds = 36000;   // seconds at start (10AM)
var daySeconds = 86400;     // seconds in a day
var setDaylight=d3.select('.leaflet-tile-pane');
var timeSlider= d3.select('.timeslider');

drawLeaderboard();

setInterval(function() {
    var trueTime = startSeconds + seconds;
    var differential = Math.cos(((trueTime+anticipateAnimation)/daySeconds)*2*Math.PI)*0.4;
    setDaylight.style('opacity', 0.6-differential);
    timeSlider.property('value', trueTime);
    //update day
    d3.select('.daycount')
        .text('DAY '+(Math.floor(trueTime/daySeconds)+1));
    //calculate and update clock hands
    var hourAngle=360*(trueTime)/(daySeconds/2);
    var minuteAngle=4320*(trueTime+anticipateAnimation)/(daySeconds/2);

    d3.select('.big.hand')
        .style('-moz-transform', 'rotate('+hourAngle+'deg)')
        .style('-webkit-transform', 'rotate('+hourAngle+'deg)');
    d3.select('.little.hand')
        .style('-moz-transform', 'rotate('+minuteAngle+'deg)')
        .style('-webkit-transform', 'rotate('+minuteAngle+'deg)');
    sortMushers();
    updateLeaderboard();
}, updateInterval);

// time is # of seconds into the race
function currentPt (musher, route, segments, time) {
    var spent = 0;
    var leg = 0;
    var id = 0;
    while (spent <= time) {
        if ((spent + musher.times[leg].legtime+musher.times[leg].rest) > time) {
            var legtime = musher.times[leg].legtime;
            var resttime = musher.times[leg].rest;
            var legTotal = legtime + resttime;
            var restPercent = resttime / legTotal;
            var legPercent = legtime / legTotal;
            var currentLegTime = time - spent;
            
            if (currentLegTime <= resttime) {
                currentDistance(leg, 0, musher, segments.features[leg].properties.start);
                return turf.point(segments.features[leg].geometry.coordinates[0]);
            } else {
                var lastLegPercent = (currentLegTime-resttime) / legtime;
                var lastLegDistance = lastLegPercent * segments.features[leg].properties.distance;
                currentDistance(leg, lastLegDistance, musher, null, segments.features[leg].properties.start, segments.features[leg].properties.stop);
                return turf.along(segments.features[leg], lastLegDistance, 'miles');
            }
        } else {
            spent += musher.times[leg].legtime + musher.times[leg].rest;
        }
        leg++;
    }
    return turf.point(segments.features[segments.features.length - 1].geometry.coordinates[segments.features[segments.features.length - 1].geometry.coordinates.length-1]);
}

function drawWaypoints () {
    var waypointLayer = new L.layerGroup().addTo(map);
    L.geoJson(waypoints, {
      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, {
          radius: 8,
          fillColor:'#dF0922',
          fillOpacity:0.75,
          stroke: false
        });
      }
    }).addTo(waypointLayer)
    .on('mouseover', function(e) {
        e.layer.openPopup();
    })
    .on('mouseout', function(e) {
        e.layer.closePopup();
    })
    .eachLayer(
        function(layer) {
            var stationName=layer.feature.properties.name;
            var fileName= stationName;
            if (['Nome','Willow'].indexOf(stationName)==-1) fileName='Checkpoint '+stationName;
            layer.bindPopup('<div class="pad1"><img src="waypoints/'+stationName.replace(/ /g, '_').toLowerCase()+'.jpg"><div class="strong" style="width:200px; padding-top:10px">'+fileName+'</div></div>',{offset:[0,-6]});
        }
    );
}

function setTime(time){
    seconds=parseFloat(time);
}

function drawLeaderboard () {
    var entries = d3.select('#leaderboard')
            .selectAll('.musherentry')
            .data(mushers)
            .enter()
            .append('div')
            .attr('class','musherentry pad1 keyline-bottom clearfix')
            .on('mouseenter',function(d){
                var targetMusher='.'+d.name.replace(/\s/g, '');
                d3.select(targetMusher)
                    .style('fill','#3887be')
                    .style('stroke','white')
                    .moveToFront();
                mushLayer.eachLayer(function(marker){
                    if (marker.feature.properties.name === d.name) {
                        marker.openPopup();
                    }})
            })
            .on('mouseleave',function(d){
                var targetMusher='.'+d.name.replace(/\s/g, '');
                d3.select(targetMusher)
                    .attr('style','');
                mushLayer.eachLayer(function(marker){
                    if (marker.feature.properties.name === d.name) {
                        marker.closePopup();
                    }})
            });
    entries
        .append('div')
        .attr('class','entrymug fl')
        .append('img')
        .attr('src',function(d){return d.img;});

    entries
        .append('h3')
        .text(function(d){return d.name;});

    entries
        .append('p')
        .attr('class', 'small quiet')
        .html(function(d){return d.location +'<br>'+d.dogs+' dogs on towline';});

    entries
        .append('span')
        .attr('class', 'pin-topright milecount pad1');

    entries
        .filter(function(d){return ['Canada','Sweden','Norway', 'Switzerland','Jamaica', 'Australia','Newzealand'].indexOf(d.home)!=-1})
        .append('img')
        .attr('class','flag pin-bottomright')
        .attr('src',function(d){return d.home.toLowerCase()+'.svg';})
}

function updateLeaderboard () {
    var entries = d3.select('#leaderboard')
            .selectAll('.musherentry')
            .data(mushers)
            .style('-moz-transform',function(d){return 'translateY('+d.place*80+'px)'})
            .style('-webkit-transform',function(d){return 'translateY('+d.place*80+'px)'});

    entries
        .select('p')
        .html(function(d){return d.location +'<br>'+d.dogs+' dogs on towline';});

    entries
        .select('.milecount')
        .text(function(d){return d.trailing;});
}
function currentDistance(leg, legDistance, musher, rest, start, stop) {
    var distance = 0;
    legs.features.forEach(function(segment, i){
        if(leg === i) {
            mushers = mushers.map(function(m){
                if(musher.name === m.name) {
                    m.distance = distance + legDistance;
                    m.dogs = musher.times[leg].dogsout;
                    if (rest) m.location = 'Arrived at '+rest;
                    else m.location = start + ' to ' + stop;
                    return m;
                } else{
                    return m;
                }
            });
            return (distance + legDistance);
        }
        distance += segment.properties.distance;
    });
}
var finishers=0;
function sortMushers() {
    sortedRanking=(mushers.map(function(n){return n.distance})).sort(function(a, b){return b-a});
    var leaderDist=sortedRanking[0];
    finishers = sortedRanking.filter(function(n){return n>891});
    mushers.forEach(function(musher, index){
        var place=sortedRanking.indexOf(musher.distance);
        if (musher.distance-leaderDist<0) {musher.trailing = Math.round((musher.distance-leaderDist)*1.095) + ' mi';}
        else {musher.trailing='LEADER'}
        sortedRanking[place]=null;
        musher.place=place+finishers;
        if (musher.distance>891) {
            musher.place=index;
            musher.trailing = '#'+(index+1);
            musher.location = musher.days+' days, '+musher.hours+' hours, '+musher.minutes+' minutes'
        }
        //if (musher.distance>891) {musher.place= index; console.log(musher.name+' finishes '+musher.place);}
    })
}

document.getElementById('timeslider').addEventListener('change', function() {
    seconds = parseFloat(this.value)-startSeconds;
});

//defines movetofront
d3.selection.prototype.moveToFront = function() {
  return this.each(function() {
    this.parentNode.appendChild(this);
  });
};

</script>

</html>