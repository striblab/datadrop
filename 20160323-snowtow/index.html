<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Minneapolis Snow Emergency Towings Winter 2016</title>
  <meta name="description" content="Minneapolis Snow Emergency Towings Winter 2016">
  <meta name="author" content="Frey Hargarten - StarTribune">

  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.css' rel='stylesheet' />
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.css' type='text/css' />

  <style>
   #wrapper { width:100%; }
   #map { height:450px; width:100%; }
   .mapboxgl-ctrl-attrib { display:none; }

  .switch { padding:10px; display:inline-block; text-align:center; width:32%; background-color:#fff; font-weight:900; font-family:"Benton Sans",Helvetica,Arial,sans-serif; border:1px solid black; }
  .switch:hover, .precinctR:hover, .precinctD:hover, .selected, .metroSwitch:hover { background-color:#333 !important; color:#fff !important; cursor:pointer; }

  .switches { text-align:center; }

  small { font-family:"Benton Sans",Helvetica,Arial,sans-serif; color:#808080; clear:both; display:block; }

  .zoom { text-align:center; float:none !important; padding:15px; }
  .legends { width:210px; height:auto; text-align:center; margin-right:auto; margin-left:auto; }
  .bigNum { display:inline-block; width:32%;  }

  #geocoder-container { width:100%; margin-top:10px; }
  #geocoder-container > div { min-width:50%; margin-left:25%; }

  #stuff { display:none; }

   @media (max-width:500px) {
    #geocoder-container > div { min-width:100%; margin-left:0; }
    .bigNum { font-size:1.3em; }
   }
  </style> 
</head>

<body>
  <div id="wrapper">
<div class="switches">
<div class="switch selected" data="all">All Tows</div>
<div class="switch" data="grant-tows">Dec. Tows</div>
<div class="switch" data="polk-tows">Feb. Tows</div>
</div>

<div class="switches">
<div class="bigNum orange3" data="all">3,216</div>
<div class="bigNum orange3" data="grant-tows">1,736</div>
<div class="bigNum orange3" data="polk-tows">1,480</div>
</div>

<div id="stuff"></div>

<div id="map"></div>
<div id='geocoder-container'></div>

<div class="breaker"></div>

<div class="legends">
  <small>Housing Density</small>
    <div class="legendContainer">
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>Less</span>
          <span class='gray2'></span>
          <span class='gray3'></span>
          <span class='gray4'></span>
          <span class='gray5'></span>
          <span style='background:#fff;'>More</span>
        </nav>
      </span>
    </div>
</div>

<div class="breaker"></div>

<div class="zoom">Reset View</div>
  </div>
</body>


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.js'></script>

<script>
// $("#headerDiv").sticky({topSpacing:1});

</script>
<script>
//LIVE JSON MAGIC

//https://script.google.com/macros/s/AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu/exec?id=1cJMavlb8PBBlbRngyzmZaG5A0yjltFwhGw0KDOC91vA&sheet=strikes
//https://script.google.com/macros/s/AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu/exec?id=10tdXdsFANvW4dtOYJrRxRwb6NYLxaWHSmr7mTNZ8px0&sheet=snowtow2016

d3.json("./data/grant.geojson", function(error, json) {
d3.json("./data/polk.geojson", function(error, json2) {
d3.json('./shapefiles/mplstracts.json', function(error, mpls) {


var dataTowGrant = json;
var dataTowPolk = json2;

var sw = new mapboxgl.LngLat(-93.716125, 44.643254);
var ne = new mapboxgl.LngLat(-92.763062, 45.350215);
var llb = new mapboxgl.LngLatBounds(sw, ne);


var sourceObj = new mapboxgl.GeoJSONSource({
   data: mpls
});

mapboxgl.accessToken = 'pk.eyJ1Ijoic2hhZG93ZmxhcmUiLCJhIjoiS3pwY1JTMCJ9.pTSXx_LFgR3XBpCNNxWPKA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/shadowflare/cilea5110001ra8ktm7409xze',
    center: [-93.266667, 44.983333],
    zoom: 10,
    minZoom: 10,
    maxBounds: llb
  //   sources: {
  //     "tracts":{
  //       "type": "geojson",
  //       "data": sourceObj
  //     }
  //   },
  //   layers: [{
  //     "id": "layer1",
  //     "source": "tracts",
  //     "type": "fill",
  //     "interactive": true,
  //     "paint": {
  //           'fill-color': '#333',
  //           'fill-outline-color': 'rgba(51, 51, 51, 1)'
  //     }
  // }]
});


//ADD CONTROLS
var geocoder = new mapboxgl.Geocoder({
    container: 'geocoder-container' // Optional. Specify a unique container for the control to be added to.
});

map.addControl(geocoder);
map.addControl(new mapboxgl.Navigation());



map.on('style.load', function () {
// D3 CHOROPLETH

    // map.addSource("mpls", sourceObj);

    // map.addSource("mpls", {
    //     type: "geojson",
    //     data: mpls
    // });

    map.addSource("grant", {
        type: "geojson",
        data: dataTowGrant
    });

    map.addSource("polk", {
        type: "geojson",
        data: dataTowPolk
    });


    $(".switch").click(function() {
        $(".switch").removeClass("selected");
        $(this).addClass("selected");
        var value = $(this).attr("data");
        map.setLayoutProperty('polk-tows', 'visibility', 'visible');
        map.setLayoutProperty('grant-tows', 'visibility', 'visible');
        if (value != "all") { map.setLayoutProperty(value, 'visibility', 'none'); }
    });


});

map.once('load', function loaded() {
  map.addSource('mpls', sourceObj);

d3.select("#stuff").selectAll(".card")
.data(mpls.features).enter().append("div")
.attr("class","card")
.html(function(d,i){ 

  var color;
  if (d.properties.B25001001 > 2000) { color = "#252525"; }
  else if (d.properties.B25001001 > 1500) { color = "#636363"; }
  else if (d.properties.B25001001 > 1000) { color = "#969696"; }
  else if (d.properties.B25001001 > 500) { color = "#CCC"; }
  else if (d.properties.B25001001 > 300) { color = "#F7F7F7"; }

   map.addLayer({
        'id': 'states-layer' + i,
        'interactive': true,
        'type': 'fill',
        'source': 'mpls',
        "filter": [
        "==",
        "name",
        d.properties.name
        ],
        'paint': {
            'fill-antialias' : true,
            // 'fill-outline-color ': '#ffffff',
            'fill-opacity': 0.3,
            'fill-color': color,
            'fill-outline-color': 'rgba(51, 51, 51, 1)'
        }
    });

   return "";
   
});

    map.addLayer({
                "id": "grant-tows",
                "type": "circle",
                "source": "grant",
                "paint": {
                    "circle-color": 'rgba(224,114,66, 0.45)',
                    "circle-radius": 4
                }
    });

    map.addLayer({
                "id": "polk-tows",
                "type": "circle",
                "source": "polk",
                "paint": {
                    "circle-color": 'rgba(224,114,66, 0.45)',
                    "circle-radius": 4
                }
    });

});

$(".zoom").click(function() {
map.flyTo({ center: [-93.266667, 44.983333], zoom: 10 });
});

geocoder.on('result', function(ev) {
  map.flyTo({ center: ev.result.geometry.coordinates, zoom: 14 });
    });

});
});
});
</script>

</html>