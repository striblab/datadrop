<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <title>Where are the best places for trick-or-treating in the metro?</title>
    <meta name="description" content="Where are the best places for trick-or-treating in the metro?">
    <meta name="author" content="Frey Hargarten - StarTribune">

    <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.css' type='text/css' />

<style>
    body { margin:0; padding:0; font-family:"Benton Sans",Helvetica,Arial,sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .bottom { position:absolute; bottom:0; width:100%; clear:both; }
    .map-overlay-container { position: absolute; width:400px; top: 0; left: 0; padding: 10px; z-index: 1; }
    .map-overlay { font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif; background-color: #fff; border-radius: 3px; padding: 10px; box-shadow:0 1px 2px rgba(0,0,0,0.20); }
    .map-overlay h2, .map-overlay p { margin: 0 0 10px; }
    .mapboxgl-ctrl-attrib { display:none; }
    .play { background-color:#fff !important; color:#000; }
    .pause { background-color:#333 !important; color:#fff; }
    #diverse { color:#299129; }
 
    #toggle { margin:0; padding:0; width:80px; height:23px; font-size:2em; -moz-border-radius:0; -webkit-border-radius:0; border-radius:0; border:0; font-weight:900; margin-left:auto; margin-right:auto; display:block; }
    #toggle:hover { background-color:#333 !important; color:#fff; cursor:pointer; }
    .navButtons { display:block; text-align:center; background-color:#fff !important; width:40px; font-size:2em; -moz-border-radius:0; -webkit-border-radius:0; border-radius:0; border:0; font-weight:900; }
    .navButtons:hover { background-color:#333 !important; color:#fff; cursor:pointer; }
    .previous { float:left; }
    .next { float:right; }

    #tracker { padding-top:10px; text-align:center; }
    .trackDot { border-radius:50%; width:10px; height:10px; display:inline-block; margin:6px; background-color:#ddd; }
    .trackDot:hover, .current { background-color:#333; cursor:pointer; }
    .dot { border-radius:50%; width:15px; height:15px; text-align:center; margin-right:auto; margin-left:auto; }
    .legendContainer { text-align:center; }

    #geocoder-container { width:100%; margin-top:10px; }
    #geocoder-container > div { min-width:100%; margin-left:0; }
    .chatter span { padding:5px; }

    .q1 { background-color:#fdd49e; color:#fff !important; font-weight:bold; }
    .q2 { background-color:#fdbb84; color:#fff !important; font-weight:bold; }
    .q3 { background-color:#FC8D59; color:#fff !important; font-weight:bold; }
    .q4 { background-color:#e34a33; color:#fff !important; font-weight:bold; }
    .q5 { background-color:#b30000; color:#fff !important; font-weight:bold; }

    small { font-family:"Benton Sans",Helvetica,Arial,sans-serif; color:#808080; clear:both; display:block; }

    .chatter { padding:20px; }

    p { font-family:"Benton Sans",Helvetica,Arial,sans-serif; }

    #info { display:none; height:150px; }

    .zoom { text-align:center; float:none !important; }
    .legends { width:210px; height:auto; text-align:center; margin-right:auto; margin-left:auto; }
    .bigNum { display:inline-block; width:32%;  }

    .mapboxgl-popup { max-width:400px; font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif; }
    .marker-title { font-weight: 700; }

    @media (max-width:770px) {
      #map { position:static; height:400px; }
      .map-overlay-container { width:100%; position:static; }
      .bottom { position:static; width:100%; clear:both; }

    }
</style>
</head>

<body>
<div id='map'></div>

<div class='map-overlay-container'>
  <div class='map-overlay'>
 <div>
<div class="legends" id="scale">
  <small class='stat'></small>
    <div class="legendContainer">
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>Less</span>
          <span class='q2'>1</span>
          <span class='q3'>2</span>
          <span class='q4'>3</span>
          <span class='q5'>4</span>
          <span style='background:#fff;'>More</span>
        </nav>
      </span>
    </div>
<!-- <div class="zoom">Reset View</div> -->
</div>

<div class="breaker"></div>

<div id="info">
    <h2 id='location-title'></h2>
    <p id='location-description'></p>
</div>
</div> 

    <div>
<button class="previous navButtons"><<</button><button class="next navButtons">>></button><button class="play myButton2" id="toggle">&#9658;</button>

<div id="tracker">
<div class="trackDot" id="d0" index="0"></div>
<div class="trackDot" id="d1" index="1"></div>
<div class="trackDot" id="d2" index="2"></div>
<div class="trackDot" id="d3" index="3"></div>
<div class="trackDot" id="d4" index="4"></div>
</div>

</div>

<div class="breaker"></div>

<div id='geocoder-container'></div>

  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="../_common_resources/js/d3-master/d3.min.js" charset="utf-8"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.0.0/mapbox-gl-geocoder.js'></script>
<script>
d3.json("http://googlescript.startribune.com/?macro=AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu&id=1RiNtORVIispxDGDxtdDljvs0CEDP94EaV2B3wbcMkXk&sheet=candy", function(error, dataLoad) {

var data = dataLoad.candy;

d3.json("./shapefiles/metrocandy.json", function(error, blocks) {
d3.json("./shapefiles/metro_cities.json", function(error, metro) {
d3.json("./shapefiles/counties.json", function(error, counties) {

var sw = new mapboxgl.LngLat(-93.716125, 44.643254);
var ne = new mapboxgl.LngLat(-92.763062, 45.350215);
var llb = new mapboxgl.LngLatBounds(sw, ne);

mapboxgl.accessToken = 'pk.eyJ1Ijoic2hhZG93ZmxhcmUiLCJhIjoiS3pwY1JTMCJ9.pTSXx_LFgR3XBpCNNxWPKA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/shadowflare/ciqznymjs0009btm891qyu49n',
    center: [-93.924866, 44.995883],
    zoom: 8,
    minZoom: 7.5
});

var geocoder = new mapboxgl.Geocoder({
    container: 'geocoder-container'
});

map.addControl(geocoder);
map.addControl(new mapboxgl.Navigation());

var title = document.getElementById('location-title');
var description = document.getElementById('location-description');

var timer = [];

function playback(index,stream) {
    title.textContent = data[index].title;

    $("#location-description").html(data[index].description);
    $(".stat").html(data[index].stat);

    $(".trackDot").removeClass("current");
    $("#d" + index).addClass("current");

    // Animate the map position based on camera properties
    map.flyTo({center:[data[index].longitude,data[index].latitude],zoom:data[index].zoom,bearing:data[index].bearing,pitch:data[index].pitch});

    console.log(index);

    if (index == 0){
      if ($(window).width() < 700) { 
      map.flyTo({ center: [-93.266667, 44.983333], zoom: 7.3 }); 
      map.setLayoutProperty('counties-layer', 'visibility', 'visible'); 
      }
    } else { map.setLayoutProperty('counties-layer', 'visibility', 'none'); }

}

function play(j,timeout){
 timer[j] = window.setTimeout(function() { playback(j); }, timeout); 
}

function stop(){
  for (var i=0; i<data.length; i++){
     clearTimeout(timer[i]);
  }
}

// Display the last title/description first
title.textContent = data[data.length - 1].title;
description.textContent = data[data.length - 1].description;


map.on('load', function() {

    //BLOCKS
  var shapeObj3 = new mapboxgl.GeoJSONSource({
   data: blocks
});

  map.addSource('blocks', shapeObj3);

   map.addLayer({
        'id': 'blocks-layer',
        'interactive': true,
        'source': 'blocks',
        'layout': {},
        'type': 'fill',
        // "filter": [
        // "==",
        // "COUNTYNAME",
        // layer[0]
        // ],
             'paint': {
            'fill-color':{
            // property: 'B19113e1',
            property: 'CandyScore', 
            stops: [
                [0, '#333'],
                [16, '#fdd49e'],
                [20, '#fdbb84'],
                [30, '#FC8D59'],
                [40, '#e34a33'],
                [50, '#b30000']
            ]
        },
             'fill-opacity': 0.6
      }
    }, 'place-neighbourhood');

    //METRO
  var shapeObj2 = new mapboxgl.GeoJSONSource({
   data: metro
});

  map.addSource('metro', shapeObj2);

   map.addLayer({
        'id': 'metro-layer',
        'interactive': true,
        'source': 'metro',
        'layout': {},
        'type': 'fill',
             'paint': {
            'fill-antialias' : true,
            'fill-opacity': 0.2,
            'fill-color': "#888",
            'fill-outline-color': 'rgba(255, 255, 255, 1)'
      }
    }, 'place-neighbourhood');

    //COUNTIES
  var shapeObj1 = new mapboxgl.GeoJSONSource({
   data: counties
});

  map.addSource('counties', shapeObj1);

   map.addLayer({
        'id': 'counties-layer',
        'interactive': false,
        'source': 'counties',
        'layout': {},
        'type': 'fill',
             'paint': {
            'fill-antialias' : true,
            'fill-opacity': 0.1,
            'fill-color': "#888",
            'fill-outline-color': 'rgba(255, 255, 255, 1)'
      }
    }, 'place-neighbourhood');

// Create a popup, but don't add it to the map yet.
var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
});

map.on('mousemove', function(e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['metro-layer'] });
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

    if (!features.length) {
        popup.remove();
        return;
    }

    var feature = features[0];

    // Populate the popup and set its coordinates
    // based on the feature found.
    popup.setLngLat(e.lngLat)
        .setHTML(feature.properties.COCTU_DESC)
        .addTo(map);
});

  playback(0);

  $("#info").show();

var index = 0;
$(document).ready(function() {
        $('#toggle').bind("click", function() {
          if ($(this).attr("class") == "play myButton2") {
             $(this).attr("class", "pause myButton2");
             $(this).html("&#9724;");
             for (var j=0; j<data.length; j++){ play(j,j*5000); if (index < data.length) { index++; } }
         }
          else {
             $(this).attr("class", "play myButton2");
             $(this).html("&#9658;");
             stop();
           }
        });
      });

$(".previous").click(function() {
  if (index > 0) {
  index--;
  stop();
  playback(index);
}
  });

$(".next").click(function() {
  if (index < data.length-1) {
  stop();
  index++;
  playback(index);
}
  });

$(".trackDot").click(function() {
  $("#toggle").attr("class", "play myButton2");
  $("#toggle").html("&#9658;");
  $(".trackDot").removeClass("current");
  $(this).addClass("current");
  stop();
  index = Number($(this).attr("index"));
  playback(Number($(this).attr("index")));
});

    $( document ).ready(function() {
        if ($(window).width() <= 770) { map.flyTo({ center: [-93.266667, 44.983333], zoom: 7.3 }); }
        else { map.flyTo({ center: [-93.924866, 44.995883], zoom: 8 }); }
    });

    $(window).resize(function() {
    if ($(window).width() <= 770) { map.flyTo({ center: [-93.266667, 44.983333], zoom: 7.3 }); }
    else { map.flyTo({ center: [-93.924866, 44.995883], zoom: 8 }); }
    });

$(".zoom").click(function() {
map.flyTo({ center: [-93.924866, 44.995883], zoom: 8.5 });
});

$(".mapboxgl-ctrl-geocoder input").attr("placeholder","Search by full address, city name, street name or zip code");

geocoder.on('result', function(ev) {
  map.flyTo({ center: ev.result.geometry.coordinates, zoom: 14 });
    });

});
});
});
});
});
</script>
</body>
</html>